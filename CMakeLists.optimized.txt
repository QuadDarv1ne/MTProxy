# Optimized CMakeLists.txt for MTProxy
# Modern CMake build configuration with performance optimizations

cmake_minimum_required(VERSION 3.15)
project(MTProxy VERSION 1.0.0 LANGUAGES C)

# Set C standard
set(CMAKE_C_STANDARD 11)
set(CMAKE_C_STANDARD_REQUIRED ON)

# Compiler detection and optimization flags
if(CMAKE_C_COMPILER_ID STREQUAL "GNU" OR CMAKE_C_COMPILER_ID STREQUAL "Clang")
    # Release optimization flags
    set(OPTIMIZATION_FLAGS "-O3" "-march=native" "-mtune=native" "-flto" 
                          "-funroll-loops" "-ffast-math" "-DNDEBUG")
    
    # Security flags
    set(SECURITY_FLAGS "-D_FORTIFY_SOURCE=2" "-fvisibility=hidden" "-fPIC")
    
    # Linker flags
    set(LINKER_FLAGS "-flto" "-Wl,--gc-sections" "-Wl,-z,relro" "-Wl,-z,now")
    
    # Debug flags
    set(DEBUG_FLAGS "-g" "-O0" "-DDEBUG" "-D_DEBUG")
    
    # Warning flags
    set(WARNING_FLAGS "-Wall" "-Wextra" "-Wno-unused-parameter" "-Wno-unused-function")
    
elseif(CMAKE_C_COMPILER_ID STREQUAL "MSVC")
    # MSVC optimization flags
    set(OPTIMIZATION_FLAGS "/O2" "/GL" "/DNDEBUG")
    set(SECURITY_FLAGS "/GS" "/DYNAMICBASE" "/NXCOMPAT")
    set(LINKER_FLAGS "/LTCG")
    set(DEBUG_FLAGS "/Zi" "/Od" "/DDEBUG")
    set(WARNING_FLAGS "/W3")
endif()

# Create optimized compile options
add_compile_options(${OPTIMIZATION_FLAGS} ${SECURITY_FLAGS} ${WARNING_FLAGS})

# Create debug compile options
set(DEBUG_COMPILE_OPTIONS ${DEBUG_FLAGS} ${WARNING_FLAGS})

# Set linker options
set(CMAKE_EXE_LINKER_FLAGS "${CMAKE_EXE_LINKER_FLAGS} ${LINKER_FLAGS}")

# Find required packages
find_package(Threads REQUIRED)
find_package(OpenSSL REQUIRED)

# Include directories
include_directories(${CMAKE_CURRENT_SOURCE_DIR})
include_directories(${OPENSSL_INCLUDE_DIR})

# Source file groups
set(COMMON_SOURCES
    common/advanced-logger.c
    common/cache-manager.c
    common/common-stats.c
    common/config-manager.c
    common/cpuid.c
    common/crc32.c
    common/crc32c.c
    common/health-check.c
    common/kprintf.c
    common/log-aggregator.c
    common/md5.c
    common/metrics-collector.c
    common/mp-queue.c
    common/mtproxy-fixes-simple.c
    common/mtproxy-fixes.c
    common/parse-config.c
    common/pid.c
    common/platform_compat.c
    common/platform_network.c
    common/precise-time.c
    common/proc-stat.c
    common/resolver.c
    common/rpc-const.c
    common/runtime-tuner.c
    common/server-functions.c
    common/sha1.c
    common/sha256.c
    common/structured-logger.c
    common/tl-parse.c
    common/vlog.c
)

set(CRYPTO_SOURCES
    crypto/aes-optimized.c
    crypto/aesni256.c
    crypto/advanced-crypto-opt.c
    crypto/crypto-optimizer.c
    crypto/crypto-performance-optimizer.c
    crypto/dh-optimized.c
    crypto/enhanced-crypto-optimizer.c
    crypto/vectorized-crypto.c
)

set(NET_SOURCES
    net/advanced-connection-pool.c
    net/advanced-network.c
    net/enhanced-tls-obfuscation.c
    net/multiproto-manager.c
    net/net-buffer-manager.c
    net/net-config.c
    net/net-connections-pool.c
    net/net-connections.c
    net/net-crypto-aes.c
    net/net-crypto-dh.c
    net/net-enhanced-networking.c
    net/net-event-handler.c
    net/net-events.c
    net/net-health-check.c
    net/net-http-server.c
    net/net-msg-buffers.c
    net/net-msg.c
    net/net-performance-manager.c
    net/net-quic-connections.c
    net/net-rpc-targets.c
    net/net-stats.c
    net/net-tcp-connections.c
    net/net-tcp-rpc-client.c
    net/net-tcp-rpc-common.c
    net/net-tcp-rpc-ext-server.c
    net/net-tcp-rpc-server.c
    net/net-thread.c
    net/net-timers.c
    net/network-analyzer.c
    net/network-connection-optimizer.c
    net/network-profiler.c
    net/oblivious-http.c
    net/pluggable-transports.c
    net/protocol-reliability.c
    net/shadowsocks-adapter.c
    net/shadowsocks-advanced.c
    net/simple-advanced-network.c
    net/tls-emulator.c
    net/websocket-support.c
)

set(SYSTEM_SOURCES
    system/connection-optimizer.c
    system/enhanced-memory-optimizer.c
    system/memory-optimization.c
    system/memory-optimizer.c
    system/memory-pool-optimizer.c
)

set(CONN_POOL_SOURCES
    conn_pool/adaptive-connection-pool.c
    conn_pool/advanced-connection-optimizer.c
    conn_pool/conn-pool.c
    conn_pool/simple-advanced-connection-optimizer.c
)

set(ENGINE_SOURCES
    engine/engine-net.c
    engine/engine-rpc-common.c
    engine/engine-rpc.c
    engine/engine-signals.c
    engine/engine.c
)

set(MT_PROTO_SOURCES
    mtproto/mtproto-config.c
    mtproto/mtproto-proxy.c
    mtproto/mtproto-v3-adapter.c
    mtproto/mtproto-version-manager.c
)

set(PERF_MONITOR_SOURCES
    perf_monitor/advanced-metrics.c
    perf_monitor/advanced-monitoring.c
    perf_monitor/distributed-tracing.c
    perf_monitor/enhanced-performance-monitor.c
    perf_monitor/extended-monitoring.c
    perf_monitor/perf-monitor.c
    perf_monitor/simple-monitoring.c
)

set(SECURITY_SOURCES
    security/security-module.c
)

set(GENERAL_SOURCES
    general/config_manager.c
    general/protocol-manager.c
)

set(INFRASTRUCTURE_SOURCES
    infrastructure/advanced-load-balancer.c
    infrastructure/auto-scaling.c
    infrastructure/load-balancer.c
)

set(JOBS_SOURCES
    jobs/jobs.c
)

# All sources
set(ALL_SOURCES
    ${COMMON_SOURCES}
    ${CRYPTO_SOURCES}
    ${NET_SOURCES}
    ${SYSTEM_SOURCES}
    ${CONN_POOL_SOURCES}
    ${ENGINE_SOURCES}
    ${MT_PROTO_SOURCES}
    ${PERF_MONITOR_SOURCES}
    ${SECURITY_SOURCES}
    ${GENERAL_SOURCES}
    ${INFRASTRUCTURE_SOURCES}
    ${JOBS_SOURCES}
    test_runner.c
)

# Create libraries
add_library(mtproxy_common STATIC ${COMMON_SOURCES})
add_library(mtproxy_crypto STATIC ${CRYPTO_SOURCES})
add_library(mtproxy_net STATIC ${NET_SOURCES})
add_library(mtproxy_system STATIC ${SYSTEM_SOURCES})
add_library(mtproxy_conn_pool STATIC ${CONN_POOL_SOURCES})
add_library(mtproxy_engine STATIC ${ENGINE_SOURCES})
add_library(mtproxy_mtproto STATIC ${MT_PROTO_SOURCES})
add_library(mtproxy_perf_monitor STATIC ${PERF_MONITOR_SOURCES})
add_library(mtproxy_security STATIC ${SECURITY_SOURCES})
add_library(mtproxy_general STATIC ${GENERAL_SOURCES})
add_library(mtproxy_infrastructure STATIC ${INFRASTRUCTURE_SOURCES})
add_library(mtproxy_jobs STATIC ${JOBS_SOURCES})

# Link libraries
target_link_libraries(mtproxy_common ${CMAKE_THREAD_LIBS_INIT})
target_link_libraries(mtproxy_crypto OpenSSL::SSL OpenSSL::Crypto)
target_link_libraries(mtproxy_net ${CMAKE_THREAD_LIBS_INIT})
target_link_libraries(mtproxy_system ${CMAKE_THREAD_LIBS_INIT})
target_link_libraries(mtproxy_conn_pool ${CMAKE_THREAD_LIBS_INIT})
target_link_libraries(mtproxy_engine ${CMAKE_THREAD_LIBS_INIT})
target_link_libraries(mtproxy_mtproto ${CMAKE_THREAD_LIBS_INIT})
target_link_libraries(mtproxy_perf_monitor ${CMAKE_THREAD_LIBS_INIT})
target_link_libraries(mtproxy_security ${CMAKE_THREAD_LIBS_INIT})
target_link_libraries(mtproxy_general ${CMAKE_THREAD_LIBS_INIT})
target_link_libraries(mtproxy_infrastructure ${CMAKE_THREAD_LIBS_INIT})
target_link_libraries(mtproxy_jobs ${CMAKE_THREAD_LIBS_INIT})

# Main executable
add_executable(mtproxy ${ALL_SOURCES})
target_link_libraries(mtproxy 
    mtproxy_common
    mtproxy_crypto
    mtproxy_net
    mtproxy_system
    mtproxy_conn_pool
    mtproxy_engine
    mtproxy_mtproto
    mtproxy_perf_monitor
    mtproxy_security
    mtproxy_general
    mtproxy_infrastructure
    mtproxy_jobs
    ${CMAKE_THREAD_LIBS_INIT}
    OpenSSL::SSL
    OpenSSL::Crypto
    m
)

# Debug build
add_executable(mtproxy_debug ${ALL_SOURCES})
target_compile_options(mtproxy_debug PRIVATE ${DEBUG_COMPILE_OPTIONS})
target_link_libraries(mtproxy_debug 
    mtproxy_common
    mtproxy_crypto
    mtproxy_net
    mtproxy_system
    mtproxy_conn_pool
    mtproxy_engine
    mtproxy_mtproto
    mtproxy_perf_monitor
    mtproxy_security
    mtproxy_general
    mtproxy_infrastructure
    mtproxy_jobs
    ${CMAKE_THREAD_LIBS_INIT}
    OpenSSL::SSL
    OpenSSL::Crypto
    m
)

# Test build
add_executable(mtproxy_test ${ALL_SOURCES})
target_compile_definitions(mtproxy_test PRIVATE ENABLE_TESTING)
target_link_libraries(mtproxy_test 
    mtproxy_common
    mtproxy_crypto
    mtproxy_net
    mtproxy_system
    mtproxy_conn_pool
    mtproxy_engine
    mtproxy_mtproto
    mtproxy_perf_monitor
    mtproxy_security
    mtproxy_general
    mtproxy_infrastructure
    mtproxy_jobs
    ${CMAKE_THREAD_LIBS_INIT}
    OpenSSL::SSL
    OpenSSL::Crypto
    m
)

# Installation
install(TARGETS mtproxy RUNTIME DESTINATION bin)

# Packaging
set(CPACK_PACKAGE_NAME "MTProxy")
set(CPACK_PACKAGE_VERSION ${PROJECT_VERSION})
set(CPACK_PACKAGE_DESCRIPTION "Enhanced MTProto Proxy Server")
set(CPACK_PACKAGE_CONTACT "Maestro7IT <maxim.dupley@gmail.com>")
set(CPACK_RESOURCE_FILE_LICENSE "${CMAKE_CURRENT_SOURCE_DIR}/LICENSE")
set(CPACK_RESOURCE_FILE_README "${CMAKE_CURRENT_SOURCE_DIR}/README.md")

include(CPack)

# Custom targets
add_custom_target(perf
    COMMAND ${CMAKE_CURRENT_BINARY_DIR}/mtproxy --perf-analysis
    DEPENDS mtproxy
    COMMENT "Running performance analysis"
)

add_custom_target(memcheck
    COMMAND valgrind --leak-check=full --show-leak-kinds=all ${CMAKE_CURRENT_BINARY_DIR}/mtproxy_debug
    DEPENDS mtproxy_debug
    COMMENT "Running memory analysis with Valgrind"
)

add_custom_target(static
    COMMAND cppcheck --enable=all --inconclusive ${CMAKE_CURRENT_SOURCE_DIR}
    COMMENT "Running static analysis with cppcheck"
)