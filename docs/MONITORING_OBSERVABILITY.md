# Мониторинг и наблюдаемость для MTProxy

## Содержание

1. [Экспорт метрик Prometheus](#экспорт-метрик-prometheus)
2. [Распределенная трассировка](#распределенная-трассировка)
3. [Структурированное логирование](#структурированное-логирование)
4. [Эндпоинты проверки работоспособности](#эндпоинты-проверки-работоспособности)
5. [Статус реализации]

## Экспорт метрик Prometheus

### Обзор

Экспорт метрик Prometheus обеспечивает стандартизованные возможности мониторинга для MTProxy, позволяя интегрироваться с популярными стеками мониторинга.

### Детали реализации

- Коллектор пользовательских метрик для специфичных данных `MTProxy`
- Стандартные типы метрик Prometheus (счетчик, показатель, гистограмма, сводка)
- Метки для размерности (тип соединения, протокол и т.д.)
- Истечение срока действия и сборка мусора для динамических меток

### Категории метрик

#### Метрики соединений

- `mtproto_connections_total` - Общее количество установленных соединений
- `mtproto_active_connections` - Текущие активные соединения
- `mtproto_connection_duration_seconds` - Гистограмма длительности соединений
- `mtproto_failed_connections_total` - Неудачные попытки соединения

#### Метрики производительности

- `mtproto_requests_total` - Общее количество обработанных запросов
- `mtproto_request_duration_seconds` - Гистограмма времени обработки запросов
- `mtproto_bytes_transferred_total` - Переданные/полученные байты
- `mtproto_encryption_operations_total` - Операции шифрования/дешифрования

#### Метрики безопасности

- `mtproto_authentication_attempts_total` - Попытки аутентификации (успех/неудача)
- `mtproto_blocked_connections_total` - Соединения, заблокированные безопасностью
- `mtproto_rate_limited_requests_total` - Запросы с ограничением скорости
- `mtproto_detected_threats_total` - Обнаруженные угрозы безопасности

#### Метрики ресурсов

- `mtproto_memory_usage_bytes` - Использование памяти процессом MTProxy
- `mtproto_cpu_usage_percent` - Процент использования ЦП
- `mtproto_fd_count` - Количество открытых файловых дескрипторов
- `mtproto_thread_count` - Количество активных потоков

### Ключевые функции

- `register_mtproto_metrics()` - Регистрация всех пользовательских метрик
- `update_metric_value()` - Обновление значений метрик
- `collect_custom_metrics()` - Сбор пользовательских метрик для экспорта
- `export_prometheus_format()` - Вывод метрик в формате Prometheus

### Преимущества

- Интеграция с существующим мониторингом Prometheus
- Стандартизованные соглашения об именовании метрик
- Подробные операционные сведения
- Возможности оповещения через PromQL

## Распределенная трассировка

### Обзор

Распределенная трассировка позволяет отслеживать запросы через несколько экземпляров MTProxy и связанные службы.

### Детали реализации

- Совместимость с API OpenTracing/OpenTelemetry
- Распространение контекста трассировки через сетевые границы
- Создание спанов для основных операций (соединение, шифрование, пересылка)
- Стратерии выборки для снижения накладных расходов
- Экспорт в Jaeger, Zipkin или другие бэкенды трассировки

### Структура трассировки

#### Корневой спан

- Установление соединения
- Процесс аутентификации
- Изначальное согласование протокола

#### Дочерние спаны

- Обработка отдельных сообщений
- Установление восходящего соединения
- Операции шифрования/дешифрования
- Пересылка ответов

### Ключевые функции

- `start_trace_session()` - Начать новую трассировку для входящего запроса
- `create_span()` - Создать дочерний спан для операции
- `inject_trace_context()` - Распространить контекст трассировки
- `finish_span()` - Завершить и записать спан

### Поддерживаемые протоколы

- Специфичная трассировка `MTProto`
- Трассировка `HTTP/HTTPS`
- Трассировка `QUIC/HTTP3`
- Внутренняя трассировка `RPC`

### Преимущества

- Видимость запросов от начала до конца
- Идентификация узких мест производительности
- Картирование зависимостей между сервисами
- Детальная разбивка задержек

## Структурированное логирование

### Обзор

Структурированное логирование обеспечивает считываемый машиной вывод журнала с последовательным форматом и богатыми метаданными.

### Детали реализации

- Вывод журнала в формате `JSON`
- Последовательные соглашения об именовании полей
- Уровни важности (`DEBUG`, `INFO`, `WARN`, `ERROR`, `FATAL`)
- Структурированные метаданные для корреляции
- Настраиваемые уровни журнала для каждого компонента

### Структура записи журнала

```json
{
  "timestamp": "2023-07-15T10:30:00.123Z",
  "level": "INFO",
  "component": "connection_manager",
  "message": "New client connected",
  "fields": {
    "client_ip": "192.168.1.100",
    "connection_id": "abc123",
    "protocol_version": "2.0"
  }
}
```

### Ключевые компоненты

- `log_entry_t` - Представление структурированной записи журнала
- `structured_logger_t` - Основная реализация регистратора
- `log_with_fields()` - Журнал с дополнительными структурированными данными
- `configure_log_format()` - Установка формата вывода журнала

### Категории журналов

#### Журналы доступа

- События подключения/отключения клиента
- Успешная/неудачная аутентификация
- События пересылки сообщений
- Нарушения протокола

#### Журналы безопасности

- Обнаружение подозрительной активности
- Заблокированные соединения
- Нарушения ограничения скорости
- События проверки сертификатов

#### Журналы производительности

- Предупреждения о медленных операциях
- События исчерпания ресурсов
- Соотношения промахов/попаданий кэша
- Увеличение частоты ошибок

### Преимущества

- Легкий парсинг и анализ
- Интеграция с инструментами агрегации журналов
- Последовательный формат для всех компонентов
- Богатый контекст для отладки

## Эндпоинты проверки работоспособности

### Обзор

Эндпоинты проверки работоспособности предоставляют стандартизованные интерфейсы для оркестрации контейнеров и систем мониторинга.

### Детали реализации

- Несколько типов проверок работоспособности (живучесть, готовность, запуск)
- Настраиваемые интервалы проверки работоспособности
- Подключаемые провайдеры проверки работоспособности
- Подробная отчетность о состоянии работоспособности

### Типы эндпоинтов

#### Проверка живучести

- `/api/health/live` - Процесс жив?
- Возвращает 200, если процесс отвечает
- Перезапуск при неработоспособности

#### Проверка готовности

- `/api/health/ready` - Сервис готов принимать трафик?
- Проверяет внутренние буферы, соединения
- Исключает из балансировщика нагрузки при неработоспособности

#### Проверка запуска

- `/api/health/startup` - Сервис завершил инициализацию?
- Используется во время последовательности запуска
- Более длительные периоды ожидания

### Индикаторы работоспособности

- Пороги использования памяти
- Доступность пула соединений
- Доступность дискового пространства
- Подключение к вышестоящим сервисам
- Длина внутренних очередей

### Ключевые функции

- `register_health_check()` - Добавить новый индикатор работоспособности
- `get_health_status()` - Общая оценка работоспособности
- `check_component_health()` - Проверка отдельного компонента
- `serve_health_endpoint()` - HTTP-обработчик для эндпоинтов работоспособности

### Формат ответа

```json
{
  "status": "healthy",
  "timestamp": "2023-07-15T10:30:00.123Z",
  "checks": {
    "memory": {"status": "healthy", "usage": "45%"},
    "connections": {"status": "healthy", "available": 95, "total": 100},
    "disk": {"status": "healthy", "usage": "23%"}
  }
}
```

### Преимущества

- Интеграция с Kubernetes/Docker
- Автоматическое восстановление сервиса
- Проверки работоспособности балансировщика нагрузки
- Проактивное обнаружение проблем

## Статус реализации

| Функция | Статус | Приоритет |
|---------|--------|----------|
| Метрики Prometheus | В плане | Высокий |
| Распределенная трассировка | В плане | Средний |
| Структурированное логирование | В плане | Высокий |
| Эндпоинты проверки работоспособности | В плане | Высокий |

## Примеры конфигурации

### Конфигурация Prometheus

```
--enable-prometheus --prometheus-port 9090 --prometheus-prefix mtproxy
```

### Конфигурация трассировки

```
--enable-tracing --tracing-backend jaeger --tracing-endpoint http://jaeger:14268
```

### Конфигурация логирования

```
--log-format json --log-level info --structured-logs
```

### Конфигурация проверки работоспособности

```
--enable-health-checks --health-port 8080 --liveness-threshold 5
```

## Рекомендации

### Для производственных систем

- Включить структурированное логирование для лучшего анализа
- Настроить соответствующее хранение метрик
- Настроить оповещения по ключевым метрикам
- Активно мониторить эндпоинты проверки работоспособности

### Для систем с высокой нагрузкой

- Использовать выборку для трассировки, чтобы снизить накладные расходы
- Настроить ротацию журналов, чтобы предотвратить исчерпание диска
- Установить соответствующие интервалы сбора метрик
- Реализовать шаблоны автоматического отключения для проверок работоспособности