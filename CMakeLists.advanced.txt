# Advanced CMake Configuration for MTProxy
# Optimized for different architectures and deployment scenarios

cmake_minimum_required(VERSION 3.15)
project(MTProxy VERSION 2.0.0 LANGUAGES C)

# Set C standard
set(CMAKE_C_STANDARD 11)
set(CMAKE_C_STANDARD_REQUIRED ON)

# Architecture detection
if(NOT DEFINED TARGET_ARCH)
    if(CMAKE_SYSTEM_PROCESSOR MATCHES "x86_64|amd64|AMD64")
        set(TARGET_ARCH "x86_64")
    elseif(CMAKE_SYSTEM_PROCESSOR MATCHES "aarch64|arm64")
        set(TARGET_ARCH "arm64")
    elseif(CMAKE_SYSTEM_PROCESSOR MATCHES "arm")
        set(TARGET_ARCH "arm32")
    else()
        set(TARGET_ARCH "generic")
    endif()
endif()

# Architecture-specific compiler flags
if(TARGET_ARCH STREQUAL "x86_64")
    set(ARCH_FLAGS "-march=x86-64-v3" "-mtune=skylake" "-mcx16" 
                   "-maes" "-msha" "-msse4.1" "-msse4.2" "-mpclmul"
                   "-mavx" "-mavx2" "-mbmi" "-mbmi2" "-mfma")
    set(CMAKE_EXE_LINKER_FLAGS "${CMAKE_EXE_LINKER_FLAGS} -march=x86-64-v3")
elseif(TARGET_ARCH STREQUAL "arm64")
    set(ARCH_FLAGS "-march=armv8-a+crc+crypto" "-mtune=cortex-a72" "-mstrict-align")
elseif(TARGET_ARCH STREQUAL "arm32")
    set(ARCH_FLAGS "-march=armv7-a" "-mfpu=neon" "-mfloat-abi=hard" "-mtune=cortex-a7")
endif()

# Compiler-specific optimizations
if(CMAKE_C_COMPILER_ID STREQUAL "GNU" OR CMAKE_C_COMPILER_ID STREQUAL "Clang")
    # Performance optimization flags
    set(OPTIMIZATION_FLAGS "-O3" "-flto" "-funroll-loops" "-ffast-math")
    
    # Security flags
    set(SECURITY_FLAGS "-D_FORTIFY_SOURCE=2" "-fstack-protector-strong")
    
    # Architecture-specific flags
    set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} ${ARCH_FLAGS}")
    
    # Linker flags
    set(CMAKE_EXE_LINKER_FLAGS "${CMAKE_EXE_LINKER_FLAGS} -flto -Wl,--gc-sections -Wl,-z,relro -Wl,-z,now")
    
    # Warning flags
    set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -Wall -Wextra -Wno-unused-parameter -Wno-unused-function")
    
elseif(CMAKE_C_COMPILER_ID STREQUAL "MSVC")
    # MSVC optimization flags
    set(OPTIMIZATION_FLAGS "/O2" "/GL" "/Ob2")
    set(SECURITY_FLAGS "/GS" "/guard:cf")
    set(CMAKE_EXE_LINKER_FLAGS "${CMAKE_EXE_LINKER_FLAGS} /LTCG")
endif()

# Build type specific flags
if(CMAKE_BUILD_TYPE STREQUAL "Debug")
    set(BUILD_FLAGS "-g" "-O0" "-DDEBUG" "-D_DEBUG")
elseif(CMAKE_BUILD_TYPE STREQUAL "Profile")
    set(BUILD_FLAGS "-O3" "-fprofile-generate")
elseif(CMAKE_BUILD_TYPE STREQUAL "Optimized")
    set(BUILD_FLAGS "-O3" "-fprofile-use" "-fprofile-correction")
elseif(CMAKE_BUILD_TYPE STREQUAL "SizeOptimized")
    set(BUILD_FLAGS "-Os" "-ffunction-sections" "-fdata-sections")
    set(CMAKE_EXE_LINKER_FLAGS "${CMAKE_EXE_LINKER_FLAGS} -Wl,--gc-sections")
else()
    # Release build
    set(BUILD_FLAGS "-DNDEBUG")
endif()

# Combine all flags
set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} ${OPTIMIZATION_FLAGS} ${SECURITY_FLAGS} ${BUILD_FLAGS}")

# Find required packages
find_package(Threads REQUIRED)
find_package(OpenSSL REQUIRED)

# Include directories
include_directories(${CMAKE_CURRENT_SOURCE_DIR})
include_directories(${CMAKE_CURRENT_SOURCE_DIR}/common)
include_directories(${CMAKE_CURRENT_SOURCE_DIR}/crypto)
include_directories(${CMAKE_CURRENT_SOURCE_DIR}/net)
include_directories(${CMAKE_CURRENT_SOURCE_DIR}/system)
include_directories(${CMAKE_CURRENT_SOURCE_DIR}/conn_pool)
include_directories(${CMAKE_CURRENT_SOURCE_DIR}/engine)
include_directories(${CMAKE_CURRENT_SOURCE_DIR}/mtproto)
include_directories(${CMAKE_CURRENT_SOURCE_DIR}/perf_monitor)
include_directories(${CMAKE_CURRENT_SOURCE_DIR}/security)
include_directories(${CMAKE_CURRENT_SOURCE_DIR}/general)
include_directories(${CMAKE_CURRENT_SOURCE_DIR}/infrastructure)
include_directories(${CMAKE_CURRENT_SOURCE_DIR}/jobs)

# Source file lists
set(COMMON_SOURCES
    common/advanced-logger.c
    common/cache-manager.c
    common/common-stats.c
    common/config-manager.c
    common/cpuid.c
    common/crc32.c
    common/crc32c.c
    common/health-check.c
    common/kprintf.c
    common/log-aggregator.c
    common/md5.c
    common/metrics-collector.c
    common/mp-queue.c
    common/mtproxy-fixes-simple.c
    common/mtproxy-fixes.c
    common/parse-config.c
    common/pid.c
    common/platform_compat.c
    common/platform_network.c
    common/precise-time.c
    common/proc-stat.c
    common/resolver.c
    common/rpc-const.c
    common/runtime-tuner.c
    common/server-functions.c
    common/sha1.c
    common/sha256.c
    common/structured-logger.c
    common/tl-parse.c
    common/vlog.c
)

set(CRYPTO_SOURCES
    crypto/aes-optimized.c
    crypto/aesni256.c
    crypto/advanced-crypto-opt.c
    crypto/crypto-optimizer.c
    crypto/crypto-performance-optimizer.c
    crypto/dh-optimized.c
    crypto/enhanced-crypto-optimizer.c
    crypto/vectorized-crypto.c
)

set(NET_SOURCES
    net/advanced-connection-pool.c
    net/advanced-network.c
    net/enhanced-tls-obfuscation.c
    net/multiproto-manager.c
    net/net-buffer-manager.c
    net/net-config.c
    net/net-connections-pool.c
    net/net-connections.c
    net/net-crypto-aes.c
    net/net-crypto-dh.c
    net/net-enhanced-networking.c
    net/net-event-handler.c
    net/net-events.c
    net/net-health-check.c
    net/net-http-server.c
    net/net-msg-buffers.c
    net/net-msg.c
    net/net-performance-manager.c
    net/net-quic-connections.c
    net/net-rpc-targets.c
    net/net-stats.c
    net/net-tcp-connections.c
    net/net-tcp-rpc-client.c
    net/net-tcp-rpc-common.c
    net/net-tcp-rpc-ext-server.c
    net/net-tcp-rpc-server.c
    net/net-thread.c
    net/net-timers.c
    net/network-analyzer.c
    net/network-connection-optimizer.c
    net/network-profiler.c
    net/oblivious-http.c
    net/pluggable-transports.c
    net/protocol-reliability.c
    net/shadowsocks-adapter.c
    net/shadowsocks-advanced.c
    net/simple-advanced-network.c
    net/tls-emulator.c
    net/websocket-support.c
    net/async-network-optimizer.c
    net/zero-copy-optimizer.c
)

set(SYSTEM_SOURCES
    system/connection-optimizer.c
    system/enhanced-memory-optimizer.c
    system/memory-optimization.c
    system/memory-optimizer.c
    system/memory-pool-optimizer.c
    system/numa-aware-allocator.c
)

set(CONN_POOL_SOURCES
    conn_pool/adaptive-connection-pool.c
    conn_pool/advanced-connection-optimizer.c
    conn_pool/conn-pool.c
    conn_pool/simple-advanced-connection-optimizer.c
)

set(ENGINE_SOURCES
    engine/engine-net.c
    engine/engine-rpc-common.c
    engine/engine-rpc.c
    engine/engine-signals.c
    engine/engine.c
)

set(MT_PROTO_SOURCES
    mtproto/mtproto-config.c
    mtproto/mtproto-proxy.c
    mtproto/mtproto-v3-adapter.c
    mtproto/mtproto-version-manager.c
)

set(PERF_MONITOR_SOURCES
    perf_monitor/advanced-metrics.c
    perf_monitor/advanced-monitoring.c
    perf_monitor/distributed-tracing.c
    perf_monitor/enhanced-performance-monitor.c
    perf_monitor/extended-monitoring.c
    perf_monitor/perf-monitor.c
    perf_monitor/simple-monitoring.c
)

set(SECURITY_SOURCES
    security/security-module.c
)

set(GENERAL_SOURCES
    general/config_manager.c
    general/protocol-manager.c
)

set(INFRASTRUCTURE_SOURCES
    infrastructure/advanced-load-balancer.c
    infrastructure/auto-scaling.c
    infrastructure/load-balancer.c
)

set(JOBS_SOURCES
    jobs/jobs.c
)

# All sources including advanced optimizers
set(ALL_SOURCES
    ${COMMON_SOURCES}
    ${CRYPTO_SOURCES}
    ${NET_SOURCES}
    ${SYSTEM_SOURCES}
    ${CONN_POOL_SOURCES}
    ${ENGINE_SOURCES}
    ${MT_PROTO_SOURCES}
    ${PERF_MONITOR_SOURCES}
    ${SECURITY_SOURCES}
    ${GENERAL_SOURCES}
    ${INFRASTRUCTURE_SOURCES}
    ${JOBS_SOURCES}
    test_runner.c
)

# Create libraries
add_library(mtproxy_common STATIC ${COMMON_SOURCES})
add_library(mtproxy_crypto STATIC ${CRYPTO_SOURCES})
add_library(mtproxy_net STATIC ${NET_SOURCES})
add_library(mtproxy_system STATIC ${SYSTEM_SOURCES})
add_library(mtproxy_conn_pool STATIC ${CONN_POOL_SOURCES})
add_library(mtproxy_engine STATIC ${ENGINE_SOURCES})
add_library(mtproxy_mtproto STATIC ${MT_PROTO_SOURCES})
add_library(mtproxy_perf_monitor STATIC ${PERF_MONITOR_SOURCES})
add_library(mtproxy_security STATIC ${SECURITY_SOURCES})
add_library(mtproxy_general STATIC ${GENERAL_SOURCES})
add_library(mtproxy_infrastructure STATIC ${INFRASTRUCTURE_SOURCES})
add_library(mtproxy_jobs STATIC ${JOBS_SOURCES})

# Set properties for architecture-specific compilation
set_property(TARGET mtproxy_common PROPERTY COMPILE_FLAGS ${ARCH_FLAGS})
set_property(TARGET mtproxy_crypto PROPERTY COMPILE_FLAGS ${ARCH_FLAGS})
set_property(TARGET mtproxy_net PROPERTY COMPILE_FLAGS ${ARCH_FLAGS})
set_property(TARGET mtproxy_system PROPERTY COMPILE_FLAGS ${ARCH_FLAGS})
set_property(TARGET mtproxy_conn_pool PROPERTY COMPILE_FLAGS ${ARCH_FLAGS})
set_property(TARGET mtproxy_engine PROPERTY COMPILE_FLAGS ${ARCH_FLAGS})
set_property(TARGET mtproxy_mtproto PROPERTY COMPILE_FLAGS ${ARCH_FLAGS})
set_property(TARGET mtproxy_perf_monitor PROPERTY COMPILE_FLAGS ${ARCH_FLAGS})
set_property(TARGET mtproxy_security PROPERTY COMPILE_FLAGS ${ARCH_FLAGS})
set_property(TARGET mtproxy_general PROPERTY COMPILE_FLAGS ${ARCH_FLAGS})
set_property(TARGET mtproxy_infrastructure PROPERTY COMPILE_FLAGS ${ARCH_FLAGS})
set_property(TARGET mtproxy_jobs PROPERTY COMPILE_FLAGS ${ARCH_FLAGS})

# Link libraries
target_link_libraries(mtproxy_common Threads::Threads)
target_link_libraries(mtproxy_crypto OpenSSL::SSL OpenSSL::Crypto)
target_link_libraries(mtproxy_net Threads::Threads)
target_link_libraries(mtproxy_system Threads::Threads)
target_link_libraries(mtproxy_conn_pool Threads::Threads)
target_link_libraries(mtproxy_engine Threads::Threads)
target_link_libraries(mtproxy_mtproto Threads::Threads)
target_link_libraries(mtproxy_perf_monitor Threads::Threads)
target_link_libraries(mtproxy_security Threads::Threads)
target_link_libraries(mtproxy_general Threads::Threads)
target_link_libraries(mtproxy_infrastructure Threads::Threads)
target_link_libraries(mtproxy_jobs Threads::Threads)

# Main executable
add_executable(mtproxy ${ALL_SOURCES})
target_link_libraries(mtproxy 
    mtproxy_common
    mtproxy_crypto
    mtproxy_net
    mtproxy_system
    mtproxy_conn_pool
    mtproxy_engine
    mtproxy_mtproto
    mtproxy_perf_monitor
    mtproxy_security
    mtproxy_general
    mtproxy_infrastructure
    mtproxy_jobs
    Threads::Threads
    OpenSSL::SSL
    OpenSSL::Crypto
    m
    rt
)

# Set target properties for architecture
set_target_properties(mtproxy PROPERTIES COMPILE_FLAGS ${ARCH_FLAGS})

# Debug build
add_executable(mtproxy_debug ${ALL_SOURCES})
set_target_properties(mtproxy_debug PROPERTIES COMPILE_FLAGS "${ARCH_FLAGS} -g -O0 -DDEBUG")
target_link_libraries(mtproxy_debug 
    mtproxy_common
    mtproxy_crypto
    mtproxy_net
    mtproxy_system
    mtproxy_conn_pool
    mtproxy_engine
    mtproxy_mtproto
    mtproxy_perf_monitor
    mtproxy_security
    mtproxy_general
    mtproxy_infrastructure
    mtproxy_jobs
    Threads::Threads
    OpenSSL::SSL
    OpenSSL::Crypto
    m
    rt
    gcov
)

# Profile build
add_executable(mtproxy_profile ${ALL_SOURCES})
set_target_properties(mtproxy_profile PROPERTIES 
    COMPILE_FLAGS "${ARCH_FLAGS} -O3 -fprofile-generate"
    LINK_FLAGS "-fprofile-generate"
)
target_link_libraries(mtproxy_profile 
    mtproxy_common
    mtproxy_crypto
    mtproxy_net
    mtproxy_system
    mtproxy_conn_pool
    mtproxy_engine
    mtproxy_mtproto
    mtproxy_perf_monitor
    mtproxy_security
    mtproxy_general
    mtproxy_infrastructure
    mtproxy_jobs
    Threads::Threads
    OpenSSL::SSL
    OpenSSL::Crypto
    m
    rt
)

# Static build
add_executable(mtproxy_static ${ALL_SOURCES})
set_target_properties(mtproxy_static PROPERTIES 
    COMPILE_FLAGS "${ARCH_FLAGS} -O2 -static"
    LINK_FLAGS "-static"
)
target_link_libraries(mtproxy_static 
    mtproxy_common
    mtproxy_crypto
    mtproxy_net
    mtproxy_system
    mtproxy_conn_pool
    mtproxy_engine
    mtproxy_mtproto
    mtproxy_perf_monitor
    mtproxy_security
    mtproxy_general
    mtproxy_infrastructure
    mtproxy_jobs
    Threads::Threads
    OpenSSL::SSL
    OpenSSL::Crypto
    m
    rt
)

# Installation
install(TARGETS mtproxy RUNTIME DESTINATION bin)

# Packaging
set(CPACK_PACKAGE_NAME "MTProxy")
set(CPACK_PACKAGE_VERSION ${PROJECT_VERSION})
set(CPACK_PACKAGE_DESCRIPTION "Enhanced MTProto Proxy Server with Advanced Optimizations")
set(CPACK_PACKAGE_CONTACT "Maestro7IT <maxim.dupley@gmail.com>")
set(CPACK_RESOURCE_FILE_LICENSE "${CMAKE_CURRENT_SOURCE_DIR}/LICENSE")
set(CPACK_RESOURCE_FILE_README "${CMAKE_CURRENT_SOURCE_DIR}/README.md")

include(CPack)

# Architecture-specific info
message(STATUS "Building MTProxy for architecture: ${TARGET_ARCH}")
message(STATUS "Compiler: ${CMAKE_C_COMPILER_ID}")
message(STATUS "Build type: ${CMAKE_BUILD_TYPE}")
message(STATUS "Architecture flags: ${ARCH_FLAGS}")

# Custom targets
add_custom_target(bench
    COMMAND ${CMAKE_CURRENT_BINARY_DIR}/mtproxy --benchmark-mode
    DEPENDS mtproxy
    COMMENT "Running performance benchmark"
)

add_custom_target(analyze
    COMMAND cppcheck --enable=all --inconclusive --std=c11 ${CMAKE_CURRENT_SOURCE_DIR}
    COMMENT "Running static analysis"
)

add_custom_target(sizes
    COMMAND size ${CMAKE_CURRENT_BINARY_DIR}/mtproxy
    DEPENDS mtproxy
    COMMENT "Showing binary size analysis"
)

# Architecture info target
add_custom_target(arch_info
    COMMAND ${CMAKE_COMMAND} -E echo "Building for architecture: ${TARGET_ARCH}"
    COMMAND ${CMAKE_COMMAND} -E echo "Compiler: ${CMAKE_C_COMPILER_ID}"
    COMMAND ${CMAKE_COMMAND} -E echo "Build type: ${CMAKE_BUILD_TYPE}"
    COMMENT "Displaying architecture information"
)