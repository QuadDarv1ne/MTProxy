# Руководство по оптимизации производительности MTProxy

Это руководство документирует улучшения производительности, реализованные в проекте MTProxy.

## Содержание
1. [Система пула соединений](#система-пула-соединений)
2. [Поддержка HTTP/3 с протоколом QUIC](#поддержка-http3-с-протоколом-quic)
3. [Управление сетевыми буферами](#управление-сетевыми-буферами)
4. [Улучшенная обработка событий](#улучшенная-обработка-событий)
5. [Метрики производительности и мониторинг](#метрики-производительности-и-мониторинг)

## Система пула соединений

### Обзор
Система пула соединений была реализована для снижения накладных расходов на создание новых соединений и улучшения повторного использования соединений.

### Основные особенности
- **Повторное использование соединений**: Соединения остаются активными и используются повторно при возможности
- **Управление таймаутами**: Неиспользуемые старые соединения автоматически очищаются
- **Потокобезопасность**: Использует мьютексы для обеспечения безопасного доступа в многопоточных средах
- **Отслеживание статистики**: Мониторит частоту попаданий, промахов и метрики повторного использования

### Детали реализации
- Расположено в: `net/net-connections-pool.c` и `net/net-connections-pool.h`
- Максимальное количество соединений в пуле: 256
- Таймаут повторного использования соединений: 30 секунд
- Функции включают:
  - `init_connection_pool()` - Инициализация пула соединений
  - `get_pooled_connection()` - Получение повторно используемого соединения
  - `return_connection_to_pool()` - Возврат соединения для повторного использования
  - `cleanup_old_connections()` - Очистка устаревших соединений

### Преимущества
- Снижает накладные расходы на установление соединений
- Улучшает время отклика для повторяющихся соединений
- Снижает потребление ресурсов
- Уменьшает накладные расходы на рукопожатие TLS/SSL для безопасных соединений

## Поддержка HTTP/3 с протоколом QUIC

### Обзор
Реализация поддержки протокола QUIC для включения подключения HTTP/3 для MTProxy.

### Основные особенности
- **Поддержка версий QUIC**: Поддерживает QUIC v1 и v2
- **Мультиплексирование потоков**: Несколько потоков через одно соединение
- **Миграция соединений**: Сохраняет соединения при изменениях IP
- **Встроенное шифрование**: Сквозное шифрование на транспортном уровне
- **Контроль перегрузки**: Адаптивные алгоритмы контроля перегрузки

### Детали реализации
- Расположено в: `net/net-quic-connections.c` и `net/net-quic-connections.h`
- Транспорт на основе UDP для минимальной задержки
- ID соединений для миграции соединений
- Управление потоками для мультиплексирования
- Контроль перегрузки на основе RTT

### Преимущества
- Более низкая задержка по сравнению с традиционным TCP/TLS
- Улучшенная производительность в сетях с высокой потерей данных
- Лучшие возможности миграции соединений
- Сокращенное время установления соединений

## Управление сетевыми буферами

### Обзор
Оптимизированная система управления буферами для снижения накладных расходов на выделение памяти и фрагментацию памяти.

### Основные особенности
- **Пул памяти**: Предварительно выделенные буферы разных размеров
- **Размерное распределение**: Разные пулы для разных размеров буферов
- **Потокобезопасные операции**: Защита доступа к пулам буферов с помощью мьютексов
- **Эффективное повторное использование**: Быстрые шаблоны выделения и освобождения памяти

### Детали реализации
- Расположено в: `net/net-buffer-manager.c` и `net/net-buffer-manager.h`
- Размеры корзин: 1КБ, 2КБ, 4КБ, 8КБ, 16КБ, 32КБ, 64КБ, 128КБ
- Размер пула: 1024 буфера на каждую корзину размера
- Функции включают:
  - `init_buffer_manager()` - Инициализация системы управления буферами
  - `allocate_buffer()` - Выделение буфера с использованием пула
  - `release_buffer()` - Возврат буфера в пул
  - `rwm_*_optimized()` - Оптимизированные операции с необработанными сообщениями

### Преимущества
- Снижение накладных расходов на выделение памяти
- Меньшая фрагментация памяти
- Более быстрое выделение/освобождение буферов
- Лучшая локальность кэша

## Улучшенная обработка событий

### Обзор
Улучшенная обработка событий на основе epoll с адаптивными таймаутами и пакетной обработкой.

### Основные особенности
- **Адаптивные таймауты**: Динамическая настройка таймаутов epoll в зависимости от активности
- **Пакетная обработка**: Обработка нескольких событий в одном системном вызове
- **Планирование по приоритетам**: Обработка событий высокого приоритета первой
- **Сбор статистики**: Отслеживание метрик обработки событий

### Детали реализации
- Расположено в: `net/net-event-handler.c` и `net/net-event-handler.h`
- Максимальное количество событий за опрос: 4096
- Начальный таймаут: 10мс, адаптивный диапазон 1-100мс
- Размер пакетной обработки: 64 события
- Edge-триггерный epoll для лучшей производительности

### Преимущества
- Снижение накладных расходов на системные вызовы
- Лучшее использование процессора
- Повышенная отзывчивость под нагрузкой
- Более эффективная обработка ввода-вывода

## Метрики производительности и мониторинг

### Статистика пула соединений
Пул соединений отслеживает следующие метрики:
- Попадания: Успешное повторное использование соединений из пула
- Промахи: Не удалось найти повторно используемое соединение
- Удалено: Соединения, удаленные из пула из-за возраста
- Повторно использовано: Всего соединений повторно использовано

### Статистика менеджера буферов
Менеджер буферов отслеживает:
- Выделено: Всего выделенных буферов
- Освобождено: Всего освобожденных буферов
- Повторно использовано: Буферы, полученные из пула
- Пиковое использование памяти

### Статистика обработчика событий
Обработчик событий отслеживает:
- События, обработанные в секунду
- Среднее время обработки
- Частота вызовов опроса
- Время ожидания на каждый вызов

## Рекомендации по использованию

### Для сценариев с высокой нагрузкой
- Увеличьте размер пула соединений для часто посещаемых целей
- Включите прогрев менеджера буферов для предварительного выделения часто используемых размеров буферов
- Мониторьте статистику для настройки значений таймаутов

### Для требований с низкой задержкой
- Сократите таймауты повторного использования соединений, чтобы обеспечить свежие соединения
- Используйте планирование событий более высокого приоритета для критических соединений
- Рассмотрите HTTP/3 для минимально возможной задержки

### Мониторинг
Регулярно отслеживайте статистику, предоставляемую каждой системой, чтобы выявлять узкие места в производительности и возможности настройки.